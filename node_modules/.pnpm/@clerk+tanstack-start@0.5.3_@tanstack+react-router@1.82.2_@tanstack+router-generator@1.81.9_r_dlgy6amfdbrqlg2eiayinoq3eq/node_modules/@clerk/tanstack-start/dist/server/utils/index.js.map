{"version":3,"sources":["../../../src/server/utils/index.ts"],"names":[],"mappings":";;;;;AAaa,IAAA,kBAAA,GAAqB,CAAC,IAAc,KAAA;AAC/C,EAAA,OAAO,EAAE,sBAAA,EAAwB,EAAE,GAAG,MAAO,EAAA;AAC/C;AAOO,SAAS,qBAAsB,CAAA,YAAA,EAA4B,sBAAiD,GAAA,EAAI,EAAA;AACrH,EAAA,MAAM,EAAE,MAAQ,EAAA,OAAA,EAAS,UAAY,EAAA,GAAG,MAAS,GAAA,YAAA;AAEjD,EAAA,MAAM,oBAAoB,kBAAmB,CAAA;AAAA,IAC3C,iBAAA,EAAmB,KAAK,MAAO,EAAA;AAAA,IAC/B,kBAAkB,YAAa,CAAA,cAAA;AAAA,IAC/B,YAAY,YAAa,CAAA,QAAA;AAAA,IACzB,UAAU,YAAa,CAAA,MAAA;AAAA,IACvB,eAAe,YAAa,CAAA,WAAA;AAAA,IAC5B,aAAa,YAAa,CAAA,SAAA;AAAA,IAC1B,aAAa,YAAa,CAAA,SAAA;AAAA,IAC1B,kBAAkB,YAAa,CAAA,cAAA;AAAA,IAC/B,kBAAkB,YAAa,CAAA,cAAA;AAAA,IAC/B,aAAA,EAAe,kBAAkB,YAAY,CAAA;AAAA,IAC7C,YAAA,EAAc,eAAe,UAAU,CAAA;AAAA,IACvC,gBAAA,EAAkB,eAAe,kBAAkB,CAAA;AAAA,IACnD,mBAAqB,EAAA,QAAA,CAAS,cAAe,CAAA,0BAA0B,CAAC,CAAA;AAAA,IACxE,gBAAkB,EAAA,QAAA,CAAS,cAAe,CAAA,uBAAuB,CAAC,CAAA;AAAA,IAClE,wBACE,EAAA,sBAAA,CAAuB,sBAA0B,IAAA,cAAA,CAAe,kCAAkC,CAAK,IAAA,EAAA;AAAA,IACzG,wBACE,EAAA,sBAAA,CAAuB,sBAA0B,IAAA,cAAA,CAAe,kCAAkC,CAAK,IAAA,EAAA;AAAA,IACzG,2BACE,EAAA,sBAAA,CAAuB,yBAA6B,IAAA,cAAA,CAAe,qCAAqC,CAAK,IAAA,EAAA;AAAA,IAC/G,2BACE,EAAA,sBAAA,CAAuB,yBAA6B,IAAA,cAAA,CAAe,qCAAqC,CAAK,IAAA;AAAA,GAChH,CAAA;AAED,EAAO,OAAA;AAAA,IACL,iBAAA;AAAA,IACA,SAAS,YAAa,CAAA;AAAA,GACxB;AACF;AASa,IAAA,YAAA,GAAe,CAAC,OAAqB,KAAA;AAChD,EAAA,MAAM,aAAgB,GAAA,IAAI,OAAQ,CAAA,OAAA,CAAQ,GAAK,EAAA;AAAA,IAC7C,SAAS,OAAQ,CAAA,OAAA;AAAA,IACjB,QAAQ,OAAQ,CAAA,MAAA;AAAA,IAChB,UAAU,OAAQ,CAAA,QAAA;AAAA,IAClB,OAAO,OAAQ,CAAA,KAAA;AAAA,IACf,QAAQ,OAAQ,CAAA;AAAA,GACjB,CAAA;AAGD,EAAI,IAAA,aAAA,CAAc,WAAW,KAAS,IAAA,aAAA,CAAc,SAAS,IAAQ,IAAA,EAAE,YAAY,aAAgB,CAAA,EAAA;AACjG,IAAC,cAAgD,MAAS,GAAA,MAAA;AAAA;AAG5D,EAAO,OAAA,aAAA;AACT","file":"index.js","sourcesContent":["import type { RequestState } from '@clerk/backend/internal';\nimport { debugRequestState } from '@clerk/backend/internal';\nimport { isTruthy } from '@clerk/shared/underscore';\n\nimport { getEnvVariable } from '../../utils/env';\nimport type { AdditionalStateOptions } from '../types';\n\n/**\n * Wraps obscured clerk internals with a readable `clerkState` key.\n * This is intended to be passed into <ClerkProvider>\n *\n * @internal\n */\nexport const wrapWithClerkState = (data: any) => {\n  return { __internal_clerk_state: { ...data } };\n};\n\n/**\n * Returns the clerk state object and observability headers to be injected into a context.\n *\n * @internal\n */\nexport function getResponseClerkState(requestState: RequestState, additionalStateOptions: AdditionalStateOptions = {}) {\n  const { reason, message, isSignedIn, ...rest } = requestState;\n\n  const clerkInitialState = wrapWithClerkState({\n    __clerk_ssr_state: rest.toAuth(),\n    __publishableKey: requestState.publishableKey,\n    __proxyUrl: requestState.proxyUrl,\n    __domain: requestState.domain,\n    __isSatellite: requestState.isSatellite,\n    __signInUrl: requestState.signInUrl,\n    __signUpUrl: requestState.signUpUrl,\n    __afterSignInUrl: requestState.afterSignInUrl,\n    __afterSignUpUrl: requestState.afterSignUpUrl,\n    __clerk_debug: debugRequestState(requestState),\n    __clerkJSUrl: getEnvVariable('CLERK_JS'),\n    __clerkJSVersion: getEnvVariable('CLERK_JS_VERSION'),\n    __telemetryDisabled: isTruthy(getEnvVariable('CLERK_TELEMETRY_DISABLED')),\n    __telemetryDebug: isTruthy(getEnvVariable('CLERK_TELEMETRY_DEBUG')),\n    __signInForceRedirectUrl:\n      additionalStateOptions.signInForceRedirectUrl || getEnvVariable('CLERK_SIGN_IN_FORCE_REDIRECT_URL') || '',\n    __signUpForceRedirectUrl:\n      additionalStateOptions.signUpForceRedirectUrl || getEnvVariable('CLERK_SIGN_UP_FORCE_REDIRECT_URL') || '',\n    __signInFallbackRedirectUrl:\n      additionalStateOptions.signInFallbackRedirectUrl || getEnvVariable('CLERK_SIGN_IN_FALLBACK_REDIRECT_URL') || '',\n    __signUpFallbackRedirectUrl:\n      additionalStateOptions.signUpFallbackRedirectUrl || getEnvVariable('CLERK_SIGN_UP_FALLBACK_REDIRECT_URL') || '',\n  });\n\n  return {\n    clerkInitialState,\n    headers: requestState.headers,\n  };\n}\n\n/**\n * Patches request to avoid duplex issues with unidici\n * For more information, see:\n * https://github.com/nodejs/node/issues/46221\n * https://github.com/whatwg/fetch/pull/1457\n * @internal\n */\nexport const patchRequest = (request: Request) => {\n  const clonedRequest = new Request(request.url, {\n    headers: request.headers,\n    method: request.method,\n    redirect: request.redirect,\n    cache: request.cache,\n    signal: request.signal,\n  });\n\n  // If duplex is not set, set it to 'half' to avoid duplex issues with unidici\n  if (clonedRequest.method !== 'GET' && clonedRequest.body !== null && !('duplex' in clonedRequest)) {\n    (clonedRequest as unknown as { duplex: 'half' }).duplex = 'half';\n  }\n\n  return clonedRequest;\n};\n"]}